<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Anatolia — Command Center Master</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #ffffff; --stripe: #f8f9fa; --border: #000000; --green: #10b981; --red: #ef4444; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #000; -webkit-font-smoothing: antialiased; }
    
    nav { background: #000; color: #fff; display: flex; padding: 0 40px; gap: 30px; position: sticky; top: 0; z-index: 100; }
    nav div { padding: 20px 0; cursor: pointer; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; border-bottom: 3px solid transparent; opacity: 0.6; }
    nav div.active { border-color: #fff; opacity: 1; }

    .view { padding: 40px; }
    .hidden { display: none; }

    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    
    .status-card { border: 2px solid var(--border); padding: 20px; position: relative; background: #fff; }
    .status-card.empty-card { border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; min-height: 180px; cursor: pointer; color: #999; }
    .status-card.empty-card:hover { border-color: #000; color: #000; }

    .card-id { font-weight: 800; font-size: 0.6rem; letter-spacing: 0.05rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; }
    .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .lbl { font-size: 0.55rem; color: #666; font-weight: 700; text-transform: uppercase; display: block; }
    .val { font-size: 0.85rem; font-weight: 600; }

    .btn { background: #000; color: #fff; border: none; padding: 10px 20px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; cursor: pointer; }
    .btn-green { background: var(--green); }
    .btn-red { background: var(--red); }
    
    #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; display: none; flex-direction: column; padding: 60px; box-sizing: border-box; overflow-y: auto; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.7rem; margin-top: 20px; }
    th { background: #eee; text-align: left; padding: 10px; border: 1px solid #ddd; position: sticky; top: 0; }
    td { padding: 10px; border: 1px solid #ddd; }
    tr:nth-child(even) { background: #f9f9f9; }

    .sync-indicator { font-size: 0.6rem; font-weight: 800; color: var(--green); margin-bottom: 10px; display: block; }
  </style>
</head>
<body>

<nav>
  <div id="nav-live" class="active" onclick="setView('live')">Production Live</div>
  <div id="nav-trials" onclick="setView('trials')">R&D Trials</div>
  <div id="nav-history" onclick="setView('history')">Master History</div>
</nav>

<div id="view-live" class="view">
  <span id="sync-status" class="sync-indicator">CONNECTED TO CLOUD</span>
  <div class="grid-container" id="live-container"></div>
</div>

<div id="view-trials" class="view hidden">
  <div class="grid-container" id="trial-container"></div>
</div>

<div id="view-history" class="view hidden">
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button class="btn" onclick="exportMaster()">Export CSV</button>
        <button class="btn btn-green" onclick="loadCloudData()">Refresh from Cloud</button>
    </div>
    <div id="history-table" style="overflow-x:auto;"></div>
</div>

<div id="modal">
  <div style="max-width:600px; margin: 0 auto; width:100%;">
    <h2 id="modal-title" style="font-weight:800; text-transform:uppercase; font-size:1.2rem; margin-bottom:30px;">Editor</h2>
    <div id="modal-fields" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"></div>
    <div style="margin-top:40px; display:flex; gap:10px;">
      <button id="save-btn" class="btn btn-green" onclick="saveEntry()">Save to Cloud</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxZpgofUKoPHs4MEDEhzvfJC6kE4hcOZPDrGt3V6f3HjyYCa1xl79LZNB2EonfdmlRS/exec";
  
  const CSV_COLUMNS = ["Date", "Production_Line", "Product_Name", "Surface", "Body_Code", "Body_Full", "Engobe_Name", "Engobe_Density", "Engobe_Grammage", "Glaze_Name", "Glaze_Density", "Glaze_Grammage", "Kiln_Min", "Kiln_Temp", "Drying_Duration", "Drying_Temp", "Source_File"];
  const fieldMap = {"Date": "Date", "Production_Line": "Production Line", "Product_Name": "Product Name", "Surface": "Surface", "Body_Code": "Body Code", "Body_Full": "Body Full", "Engobe_Name": "Engobe Name", "Engobe_Density": "Engobe Density", "Engobe_Grammage": "Engobe Grammage", "Glaze_Name": "Glaze Name", "Glaze_Density": "Glaze Density", "Glaze_Grammage": "Glaze Grammage", "Kiln_Min": "Kiln Min", "Kiln_Temp": "Kiln Temp", "Drying_Duration": "Drying Duration", "Drying_Temp": "Drying Temp", "Source_File": "Source File"};

  let state = {
    view: 'live',
    live: [{ active: false, line: '1' }, { active: false, line: '2' }, { active: false, line: '3' }],
    trials: [],
    history: [],
    sortKey: 'Date',
    sortAsc: false,
    editingType: '', 
    editingIndex: -1
  };

  async function loadCloudData() {
    document.getElementById('sync-status').innerText = "SYNCING...";
    try {
      const response = await fetch(API_URL);
      const data = await response.json();
      state.history = data;
      
      // Auto-populate Live Lines from most recent entries for each line
      const lines = ['Line 1', 'Line 2', 'Line 3'];
      lines.forEach((ln, idx) => {
          const match = data.filter(r => r.Production_Line === ln).sort((a,b) => b.Date.localeCompare(a.Date))[0];
          if (match) {
              state.live[idx] = { ...match, active: true, line: (idx+1).toString() };
          } else {
              state.live[idx] = { active: false, line: (idx+1).toString() };
          }
      });
      document.getElementById('sync-status').innerText = "CLOUD SYNCED";
      render();
    } catch (e) {
      document.getElementById('sync-status').innerText = "OFFLINE - USING LOCAL CACHE";
      console.error(e);
    }
  }

  function render() {
    renderLive();
    renderTrials();
    renderHistory();
  }

  function renderLive() {
    document.getElementById('live-container').innerHTML = state.live.map((l, i) => {
      if (!l.active) {
        return `<div class="status-card empty-card" onclick="openEditor('live', ${i})">
                  <div style="text-align:center;">
                    <div style="font-size:2rem;">+</div>
                    <div style="font-weight:800; font-size:0.7rem;">LINE ${l.line} EMPTY</div>
                  </div>
                </div>`;
      }
      return `
        <div class="status-card">
          <div class="card-id">LINE ${l.line} <span style="font-size:0.55rem; color:var(--green)">● ACTIVE</span></div>
          <div class="data-row">
              <div><span class="lbl">Product</span><span class="val">${l.Product_Name || '---'}</span></div>
              <div><span class="lbl">Surface</span><span class="val">${l.Surface || '---'}</span></div>
          </div>
          <div class="data-row">
              <div><span class="lbl">Body Code</span><span class="val">${l.Body_Code || '---'}</span></div>
              <div><span class="lbl">Kiln Temp</span><span class="val">${l.Kiln_Temp || '---'}°C</span></div>
          </div>
          <div style="display:flex; gap:10px; margin-top:10px;">
              <button class="btn" style="padding:5px 10px; flex:1;" onclick="openEditor('live', ${i})">Update</button>
              <button class="btn btn-green" style="padding:5px 10px; flex:1;" onclick="archiveLive(${i})">Archive</button>
          </div>
        </div>
      `;
    }).join('');
  }

  function renderTrials() {
    document.getElementById('trial-container').innerHTML = state.trials.map((t, i) => `
      <div class="status-card" style="border-style:dashed;">
        <div class="card-id">TRIAL #${i+1}</div>
        <div class="data-row">
            <div><span class="lbl">Product</span><span class="val">${t.Product_Name || 'New Trial'}</span></div>
            <div><span class="lbl">Kiln</span><span class="val">${t.Kiln_Temp || '--'}°C</span></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" style="padding:5px 10px; flex:1;" onclick="openEditor('trials', ${i})">Edit</button>
            <button class="btn btn-red" style="padding:5px 10px;" onclick="deleteTrial(${i})">×</button>
        </div>
      </div>
    `).join('') + `<div class="status-card empty-card" onclick="openEditor('trials', -1)">+ NEW TRIAL</div>`;
  }

  function renderHistory() {
    if (!document.getElementById('history-table')) return;
    const sorted = [...state.history].sort((a, b) => {
        let v1 = a[state.sortKey] || '', v2 = b[state.sortKey] || '';
        return state.sortAsc ? (v1 > v2 ? 1 : -1) : (v1 < v2 ? 1 : -1);
    });
    const headerHtml = CSV_COLUMNS.map(col => `<th onclick="setSort('${col}')" style="cursor:pointer; white-space:nowrap;">${fieldMap[col]} ${state.sortKey === col ? (state.sortAsc ? '↑' : '↓') : ''}</th>`).join('');
    const bodyHtml = sorted.map(row => `<tr>${CSV_COLUMNS.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`).join('');
    document.getElementById('history-table').innerHTML = `<table><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
  }

  function openEditor(type, index) {
    state.editingType = type;
    state.editingIndex = index;
    const item = index === -1 ? {} : (type === 'live' ? state.live[index] : state.trials[index]);
    document.getElementById('modal-title').innerText = index === -1 ? 'New Trial' : (type === 'live' ? `Update Line ${item.line}` : 'Edit Trial');
    let html = '';
    CSV_COLUMNS.forEach(col => {
        if (type === 'live' && col === 'Production_Line') return;
        let val = item[col] || '';
        html += `<div><label class="lbl">${fieldMap[col]}</label><input type="text" id="inp-${col}" value="${val}" style="width:100%; padding:8px; border:1px solid #000; box-sizing:border-box;"></div>`;
    });
    document.getElementById('modal-fields').innerHTML = html;
    document.getElementById('modal').style.display = 'flex';
  }

  async function saveEntry() {
    const btn = document.getElementById('save-btn');
    btn.innerText = "SAVING...";
    btn.disabled = true;

    let entry = {};
    CSV_COLUMNS.forEach(col => {
        const el = document.getElementById(`inp-${col}`);
        if (el) entry[col] = el.value;
    });

    if (state.editingType === 'live') {
        entry.Production_Line = 'Line ' + state.live[state.editingIndex].line;
        if (!entry.Date) entry.Date = new Date().toLocaleDateString('tr-TR');
        await pushToCloud(entry);
    } else {
        if (state.editingIndex === -1) state.trials.push(entry);
        else state.trials[state.editingIndex] = entry;
    }

    btn.innerText = "SAVE TO CLOUD";
    btn.disabled = false;
    closeModal();
    loadCloudData();
  }

  async function archiveLive(index) {
    const entry = { ...state.live[index] };
    delete entry.active;
    delete entry.line;
    if (!entry.Date) entry.Date = new Date().toLocaleDateString('tr-TR');
    
    document.getElementById('sync-status').innerText = "ARCHIVING...";
    await pushToCloud(entry);
    loadCloudData();
  }

  async function pushToCloud(entry) {
    try {
      await fetch(API_URL, {
        method: 'POST',
        mode: 'no-cors', // Apps Script requires no-cors or specialized headers
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry)
      });
    } catch (e) {
      console.error("Cloud save failed", e);
    }
  }

  function setSort(key) { state.sortKey = key; state.sortAsc = !state.sortAsc; render(); }
  function deleteTrial(i) { state.trials.splice(i,1); render(); }
  function closeModal() { document.getElementById('modal').style.display = 'none'; }
  function exportMaster() {
    const csv = Papa.unparse(state.history);
    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = "Production_History.csv";
    link.click();
  }

  // Initial Fetch
  loadCloudData();
</script>
</body>
</html>