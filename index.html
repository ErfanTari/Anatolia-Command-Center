<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Anatolia — Command Center Master</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #ffffff; --border: #000000; --green: #10b981; --red: #ef4444; --gray: #f3f4f6; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #000; }
    
    nav { background: #000; color: #fff; display: flex; padding: 0 40px; gap: 30px; position: sticky; top: 0; z-index: 100; }
    nav div { padding: 20px 0; cursor: pointer; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; border-bottom: 3px solid transparent; opacity: 0.6; }
    nav div.active { border-color: #fff; opacity: 1; }

    .view { padding: 40px; }
    .hidden { display: none; }

    /* UI Enhancement for Cards */
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; }
    .status-card { border: 2px solid var(--border); padding: 24px; background: #fff; transition: transform 0.2s; }
    .status-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
    .status-card.empty-card { border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; min-height: 220px; cursor: pointer; color: #999; }
    
    .card-id { font-weight: 800; font-size: 0.65rem; margin-bottom: 15px; border-bottom: 2px solid #000; padding-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    .data-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
    .lbl { font-size: 0.55rem; color: #666; font-weight: 700; text-transform: uppercase; display: block; margin-bottom: 2px; }
    .val { font-size: 0.85rem; font-weight: 700; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* Trial Buttons Section */
    .digital-options { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 15px; }
    .opt-btn { font-size: 0.55rem; font-weight: 800; padding: 6px 10px; border: 1px solid #000; cursor: pointer; background: #fff; text-transform: uppercase; }
    .opt-btn.active { background: #000; color: #fff; }

    /* Controls & History */
    .search-container { margin-bottom: 20px; display: flex; gap: 10px; }
    .input-box { border: 2px solid #000; padding: 12px; font-family: inherit; font-weight: 600; font-size: 0.8rem; }
    .btn { background: #000; color: #fff; border: none; padding: 12px 24px; font-size: 0.65rem; font-weight: 800; text-transform: uppercase; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    .btn-green { background: var(--green); }
    .btn-red { background: var(--red); }
    
    #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.98); z-index: 1000; display: none; flex-direction: column; padding: 60px; box-sizing: border-box; overflow-y: auto; }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.7rem; margin-top: 20px; }
    th { background: #000; color: #fff; text-align: left; padding: 12px; border: 1px solid #000; cursor: pointer; position: sticky; top: 0; }
    th:hover { background: #333; }
    td { padding: 12px; border: 1px solid #ddd; font-weight: 500; }
    tr:nth-child(even) { background: var(--gray); }

    .sync-indicator { font-size: 0.6rem; font-weight: 800; color: var(--green); margin-bottom: 10px; display: block; }
  </style>
</head>
<body>

<nav>
  <div id="nav-live" class="active" onclick="setView('live')">Production Live</div>
  <div id="nav-trials" onclick="setView('trials')">R&D Trials</div>
  <div id="nav-history" onclick="setView('history')">Master History</div>
</nav>

<div id="view-live" class="view">
  <span id="sync-status" class="sync-indicator">READY</span>
  <div class="grid-container" id="live-container"></div>
</div>

<div id="view-trials" class="view hidden">
  <div class="grid-container" id="trial-container"></div>
</div>

<div id="view-history" class="view hidden">
    <div class="search-container">
        <input type="text" id="history-search" class="input-box" placeholder="Search Product Name..." oninput="renderHistory()" style="flex:1;">
        <button class="btn" onclick="exportMaster()">Export CSV</button>
        <button class="btn btn-green" onclick="loadCloudData()">Refresh Cloud</button>
    </div>
    <div id="history-table" style="overflow-x:auto; max-height: 70vh;"></div>
</div>

<div id="modal">
  <div style="max-width:800px; margin: 0 auto; width:100%;">
    <h2 id="modal-title" style="font-weight:800; text-transform:uppercase; font-size:1.5rem; margin-bottom:30px;">Editor</h2>
    <div id="modal-fields" style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;"></div>
    <div style="margin-top:40px; display:flex; gap:15px;">
      <button id="save-btn" class="btn btn-green" onclick="saveEntry()">Commit to Cloud</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbyUylSn0XWy6iTVSqrjwDmmSkXHl0EOx9wf1ovtp3TLvlj5KeFgziGr92H3CQ1PrEi-/exec";
  
  // Cleaned up columns (Point 7)
  const CSV_COLUMNS = ["Date", "Production_Line", "Product_Name", "Surface", "Body_Code", "Engobe_Name", "Engobe_Density", "Engobe_Grammage", "Glaze_Name", "Glaze_Density", "Glaze_Grammage", "Kiln_Min", "Kiln_Temp", "Drying_Duration", "Drying_Temp", "Source_File", "Digital_Type"];
  const fieldMap = {"Date": "Date", "Production_Line": "Line", "Product_Name": "Product", "Surface": "Surface", "Body_Code": "Body", "Engobe_Name": "Engobe Name", "Engobe_Density": "Eng. Density", "Engobe_Grammage": "Eng. Gram", "Glaze_Name": "Glaze Name", "Glaze_Density": "Glz. Density", "Glaze_Grammage": "Glz. Gram", "Kiln_Min": "Kiln Min", "Kiln_Temp": "Kiln Temp", "Drying_Duration": "Dry Dur", "Drying_Temp": "Dry Temp", "Source_File": "Source", "Digital_Type": "Digital Type"};

  let state = {
    view: 'live',
    live: [{ active: false, line: '1' }, { active: false, line: '2' }, { active: false, line: '3' }],
    trials: [],
    history: [],
    sortKey: 'Date',
    sortAsc: false,
    editingType: '', 
    editingIndex: -1
  };

  function loadCloudData() {
    document.getElementById('sync-status').innerText = "FETCHING CLOUD DATA...";
    const script = document.createElement('script');
    script.src = `${API_URL}?callback=handleResponse`;
    document.body.appendChild(script);
  }

  window.handleResponse = function(data) {
    state.history = data;
    const lines = ['Line 1', 'Line 2', 'Line 3'];
    lines.forEach((ln, idx) => {
        const match = data.filter(r => r.Production_Line === ln).sort((a,b) => b.Date.localeCompare(a.Date))[0];
        if (match) state.live[idx] = { ...match, active: true, line: (idx+1).toString() };
    });
    document.getElementById('sync-status').innerText = "CLOUD SYNCED";
    render();
  };

  function setView(v) {
    state.view = v;
    document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('nav div').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${v}`).classList.remove('hidden');
    document.getElementById(`nav-${v}`).classList.add('active');
    render();
  }

  function render() {
    renderLive();
    renderTrials();
    renderHistory();
  }

  // Point 4 & 6: Enhanced Box UI
  function renderLive() {
    document.getElementById('live-container').innerHTML = state.live.map((l, i) => {
      if (!l.active) return `<div class="status-card empty-card" onclick="openEditor('live', ${i})"><div style="text-align:center;"><div style="font-size:2rem;">+</div><div style="font-weight:800; font-size:0.7rem;">LINE ${l.line} EMPTY</div></div></div>`;
      return `
        <div class="status-card">
          <div class="card-id">LINE ${l.line} <span style="color:var(--green)">● ACTIVE</span></div>
          <div class="data-row">
            <div><span class="lbl">Product</span><span class="val">${l.Product_Name}</span></div>
            <div><span class="lbl">Surface</span><span class="val">${l.Surface}</span></div>
          </div>
          <div class="data-row">
            <div><span class="lbl">Body Code</span><span class="val">${l.Body_Code}</span></div>
            <div><span class="lbl">Kiln Temp</span><span class="val">${l.Kiln_Temp}°C (${l.Kiln_Min}m)</span></div>
          </div>
          <div class="data-row">
            <div><span class="lbl">Engobe</span><span class="val">${l.Engobe_Name} (${l.Engobe_Density})</span></div>
            <div><span class="lbl">Glaze</span><span class="val">${l.Glaze_Name}</span></div>
          </div>
          <div style="display:flex; gap:10px; margin-top:15px;">
            <button class="btn" onclick="openEditor('live', ${i})" style="flex:1;">Update</button>
            <button class="btn btn-green" onclick="archiveLive(${i})" style="flex:1;">Archive</button>
          </div>
        </div>`;
    }).join('');
  }

  // Point 4 & 5: Enhanced Trial Box with Digital Buttons
  function renderTrials() {
    const trialsInCloud = state.history.filter(h => h.Production_Line === "Trial");
    document.getElementById('trial-container').innerHTML = trialsInCloud.map((t, i) => {
      const digitalTypes = ["1 Digital White", "2 Digital White", "Glu", "Gloss"];
      return `
      <div class="status-card" style="border-style:dashed;">
        <div class="card-id">TRIAL ARCHIVE <span style="opacity:0.5">${t.Date}</span></div>
        <div class="data-row">
            <div><span class="lbl">Product</span><span class="val">${t.Product_Name}</span></div>
            <div><span class="lbl">Body</span><span class="val">${t.Body_Code}</span></div>
        </div>
        <div class="digital-options">
            ${digitalTypes.map(type => `<div class="opt-btn ${t.Digital_Type === type ? 'active' : ''}">${type}</div>`).join('')}
        </div>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button class="btn" style="flex:1" onclick="openEditor('trials', ${state.history.indexOf(t)})">Edit</button>
            <button class="btn btn-red" onclick="deleteTrial(${state.history.indexOf(t)})">×</button>
        </div>
      </div>`;
    }).join('') + `<div class="status-card empty-card" onclick="openEditor('trials', -1)">+ NEW TRIAL</div>`;
  }

  // Point 2 & 3: Search and Sort
  function renderHistory() {
    const tableDiv = document.getElementById('history-table');
    const searchTerm = document.getElementById('history-search').value.toLowerCase();
    
    let filtered = state.history.filter(row => row.Product_Name.toLowerCase().includes(searchTerm));
    
    filtered.sort((a, b) => {
        let v1 = a[state.sortKey], v2 = b[state.sortKey];
        return state.sortAsc ? (v1 > v2 ? 1 : -1) : (v1 < v2 ? 1 : -1);
    });

    const headerHtml = CSV_COLUMNS.map(col => `<th onclick="setSort('${col}')">${fieldMap[col]} ${state.sortKey === col ? (state.sortAsc ? '↑' : '↓') : ''}</th>`).join('');
    const bodyHtml = filtered.map(row => `<tr>${CSV_COLUMNS.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`).join('');
    tableDiv.innerHTML = `<table><thead><tr>${headerHtml}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
  }

  function setSort(key) {
    if (state.sortKey === key) state.sortAsc = !state.sortAsc;
    else { state.sortKey = key; state.sortAsc = false; }
    renderHistory();
  }

  function openEditor(type, index) {
    state.editingType = type; 
    state.editingIndex = index;
    const item = index === -1 ? {} : (type === 'live' ? state.live[index] : state.history[index]);
    
    document.getElementById('modal-title').innerText = index === -1 ? 'New Trial' : 'Edit Entry';
    
    let html = '';
    CSV_COLUMNS.forEach(col => {
        if (type === 'live' && col === 'Production_Line') return;
        if (col === "Digital_Type") {
            html += `<div style="grid-column: span 2;"><label class="lbl">Digital Type Selection</label>
            <select id="inp-${col}" class="input-box" style="width:100%;">
                <option value="">None</option>
                <option value="1 Digital White" ${item[col] === '1 Digital White' ? 'selected' : ''}>1 Digital White</option>
                <option value="2 Digital White" ${item[col] === '2 Digital White' ? 'selected' : ''}>2 Digital White</option>
                <option value="Glu" ${item[col] === 'Glu' ? 'selected' : ''}>Glu</option>
                <option value="Gloss" ${item[col] === 'Gloss' ? 'selected' : ''}>Gloss</option>
            </select></div>`;
        } else {
            html += `<div><label class="lbl">${fieldMap[col]}</label><input type="text" id="inp-${col}" class="input-box" value="${item[col] || ''}" style="width:100%;"></div>`;
        }
    });
    document.getElementById('modal-fields').innerHTML = html;
    document.getElementById('modal').style.display = 'flex';
  }

  function saveEntry() {
    let entry = {};
    CSV_COLUMNS.forEach(col => { entry[col] = document.getElementById(`inp-${col}`)?.value || ""; });
    
    // Point 1: Trials now save to cloud
    if (state.editingType === 'trials') {
        entry.Production_Line = "Trial";
    } else {
        entry.Production_Line = 'Line ' + (state.editingIndex + 1);
    }
    
    if (!entry.Date) entry.Date = new Date().toLocaleDateString('tr-TR');
    pushToCloud(entry);
    closeModal();
    setTimeout(loadCloudData, 1500); // Reload after sync
  }

  function pushToCloud(entry) {
    const params = new URLSearchParams(entry).toString();
    const img = new Image(); 
    img.src = `${API_URL}?${params}&method=POST`;
    document.getElementById('sync-status').innerText = "SYNCING TO GOOGLE SHEETS...";
  }

  function archiveLive(index) {
    const entry = { ...state.live[index] };
    delete entry.active; delete entry.line;
    pushToCloud(entry);
    setTimeout(loadCloudData, 1500);
  }

  function setView(v) { state.view = v; render(); }
  function closeModal() { document.getElementById('modal').style.display = 'none'; }
  function exportMaster() {
    const csv = Papa.unparse(state.history);
    const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "Production_History.csv";
    link.click();
  }

  loadCloudData();
</script>
</body>
</html>
