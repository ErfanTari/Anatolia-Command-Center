<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Anatolia — Command Center v4.2</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg: #f4f7f6; 
      --card-bg: #ffffff;
      --text-main: #1a1a1a;
      --text-sub: #6b7280;
      --accent: #000000;
      --green: #10b981; 
      --blue: #3b82f6; 
      --red: #ef4444;
      --border: #e5e7eb;
    }

    body { 
      font-family: 'Inter', sans-serif; 
      margin: 0; 
      background: var(--bg); 
      color: var(--text-main); 
      -webkit-font-smoothing: antialiased;
    }
    
    /* Navigation */
    nav { 
      background: var(--accent); 
      color: #fff; 
      display: flex; 
      padding: 0 40px; 
      gap: 40px; 
      position: sticky; 
      top: 0; 
      z-index: 100;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    nav div { 
      padding: 24px 0; 
      cursor: pointer; 
      font-size: 0.75rem; 
      font-weight: 700; 
      text-transform: uppercase; 
      letter-spacing: 0.05em;
      border-bottom: 3px solid transparent; 
      transition: all 0.2s ease;
      opacity: 0.7;
    }
    nav div:hover { opacity: 1; }
    nav div.active { border-color: #fff; opacity: 1; }

    .view { padding: 40px; max-width: 1400px; margin: 0 auto; }
    .hidden { display: none; }
    
    /* Grid & Cards */
    .grid { 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(420px, 1fr)); 
      gap: 24px; 
    }
    
    .card { 
      background: var(--card-bg); 
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 28px; 
      display: flex; 
      flex-direction: column; 
      min-height: 400px; 
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    
    .card-head { 
      display: flex; 
      justify-content: space-between; 
      align-items: flex-start;
      margin-bottom: 24px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 12px;
    }
    .line-badge {
      background: #f3f4f6;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 0.65rem;
      font-weight: 800;
      color: var(--text-main);
    }
    .date-val { font-size: 0.7rem; color: var(--text-sub); font-weight: 500; }

    /* Typography */
    .row { margin-bottom: 16px; }
    .lbl { 
      font-size: 0.6rem; 
      font-weight: 700; 
      text-transform: uppercase; 
      color: var(--text-sub); 
      letter-spacing: 0.025em;
      margin-bottom: 4px;
      display: block;
    }
    .main-val { font-size: 1.05rem; font-weight: 700; color: var(--text-main); display: block; }
    .sub-val { 
      font-size: 0.75rem; 
      font-weight: 500; 
      color: var(--blue); 
      background: #eff6ff;
      padding: 2px 8px;
      border-radius: 4px;
      margin-left: 8px;
      display: inline-block;
    }

    /* R&D Checkboxes */
    .check-group { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 10px; 
      margin-top: 20px; 
      padding-top: 20px; 
      border-top: 1px dashed var(--border); 
    }
    .check-item { 
      font-size: 0.6rem; 
      font-weight: 700; 
      padding: 6px 12px; 
      border: 1px solid var(--border); 
      border-radius: 20px; 
      color: var(--text-sub);
      background: #fafafa;
    }
    .check-item.active { 
      background: var(--accent); 
      color: #fff; 
      border-color: var(--accent);
    }

    /* Buttons */
    .btn { 
      border-radius: 8px;
      border: none; 
      padding: 14px; 
      font-size: 0.7rem; 
      font-weight: 700; 
      text-transform: uppercase; 
      cursor: pointer; 
      transition: all 0.2s ease;
      margin-top: auto;
      text-align: center;
    }
    .btn-green { background: var(--green); color: white; }
    .btn-green:hover { background: #059669; }
    .btn-blue { background: var(--blue); color: white; }
    .btn-blue:hover { background: #2563eb; }
    
    .empty-card { 
      border: 2px dashed #cbd5e1; 
      background: transparent;
      justify-content: center; 
      align-items: center; 
      color: var(--text-sub);
      box-shadow: none;
    }
    .empty-card:hover { background: #fff; border-color: var(--accent); color: var(--accent); }

    /* Modal & Table */
    #modal { 
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
      background: rgba(0,0,0,0.5); backdrop-filter: blur(4px);
      z-index: 1000; display: none; padding: 40px; box-sizing: border-box; 
    }
    .modal-content {
      background: #fff;
      max-width: 800px;
      margin: 0 auto;
      padding: 40px;
      border-radius: 16px;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .form-grid input {
      width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit;
    }

    table { width: 100%; border-collapse: separate; border-spacing: 0; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
    th { background: #f9fafb; padding: 16px; font-size: 0.65rem; text-transform: uppercase; font-weight: 700; text-align: left; color: var(--text-sub); border-bottom: 1px solid var(--border); }
    td { padding: 16px; font-size: 0.75rem; background: #fff; border-bottom: 1px solid var(--border); }

    #sync-status { 
      position: fixed; bottom: 24px; right: 24px; 
      font-size: 0.65rem; font-weight: 700; 
      background: #fff; color: var(--text-main); 
      padding: 8px 16px; border-radius: 50px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid var(--border);
      display: flex; align-items: center; gap: 8px;
    }
    .status-dot { width: 8px; height: 8px; background: var(--green); border-radius: 50%; }

    /* Card Image (Task 5) */
    .card-image {
      width: calc(100% + 56px);
      margin: -28px -28px 20px -28px;
      height: 180px;
      object-fit: cover;
      background: #e5e7eb;
      display: block;
      border-radius: 12px 12px 0 0;
    }

    /* History CRUD Controls (Task 1) */
    .history-controls {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
      align-items: center;
    }
    .btn-sm {
      border: none;
      padding: 10px 18px;
      font-size: 0.65rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .btn-edit-mode { background: #f3f4f6; color: var(--text-main); }
    .btn-edit-mode.active { background: #fbbf24; color: #000; }
    .btn-edit-mode:hover { opacity: 0.85; }
    .btn-add-row { background: var(--green); color: white; }
    .btn-add-row:hover { background: #059669; }
    .btn-cleanup { background: #fbbf24; color: #000; }

    /* Sortable headers */
    th.sortable { cursor: pointer; user-select: none; }
    th.sortable:hover { color: var(--text-main); }
    th.sort-asc::after { content: " ▲"; font-size: 0.5rem; }
    th.sort-desc::after { content: " ▼"; font-size: 0.5rem; }

    /* Row actions on hover */
    .row-actions { display: flex; gap: 4px; opacity: 0; transition: opacity 0.15s; }
    tr:hover .row-actions { opacity: 1; }
    .row-action-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-sub);
      width: 26px; height: 26px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.7rem;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .row-action-btn:hover { background: #f3f4f6; color: var(--text-main); }
    .row-action-btn.delete:hover { background: var(--red); color: white; border-color: var(--red); }
    .row-action-btn.save:hover { background: var(--green); color: white; border-color: var(--green); }

    /* Inline editing */
    td.editing { padding: 4px; }
    td.editing input {
      width: 100%;
      background: #fff;
      border: 1px solid var(--green);
      color: var(--text-main);
      padding: 8px;
      border-radius: 4px;
      font-family: inherit;
      font-size: 0.7rem;
    }

    /* Discard button (Task 2) */
    .btn-red { background: var(--red); color: white; }
    .btn-red:hover { background: #dc2626; }

    /* Card button group */
    .card-actions { display: flex; gap: 8px; margin-top: auto; }
    .card-actions .btn { flex: 1; margin-top: 0; }

    /* Modal image preview */
    .modal-img-preview {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 10px;
      margin-bottom: 20px;
      background: #e5e7eb;
      display: none;
    }

    /* Form select styling */
    .form-grid select {
      width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; background: #fff; color: var(--text-main);
    }
  </style>
</head>
<body>

<div id="sync-status"><div class="status-dot"></div> <span id="status-text">INITIALIZING</span></div>

<nav>
  <div id="nav-live" class="active" onclick="setView('live')">Live Production</div>
  <div id="nav-trials" onclick="setView('trials')">R&D Trials</div>
  <div id="nav-history" onclick="setView('history')">Master History</div>
</nav>

<div id="view-live" class="view"><div class="grid" id="live-container"></div></div>
<div id="view-trials" class="view hidden"><div class="grid" id="trial-container"></div></div>
<div id="view-history" class="view hidden">
    <div style="margin-bottom:24px;">
        <input type="text" id="search" placeholder="Search by Product Name..." oninput="renderHistory()"
        style="width:100%; padding:16px; border-radius:12px; border:1px solid var(--border); font-size:0.9rem; box-shadow: 0 1px 2px rgba(0,0,0,0.05);">
    </div>
    <div class="history-controls">
      <button class="btn-sm btn-edit-mode" id="btn-edit-mode" onclick="toggleEditMode()">Edit Mode</button>
      <button class="btn-sm btn-add-row hidden" id="btn-add-row" onclick="addHistoryRow()">+ Add Row</button>
      <button class="btn-sm btn-cleanup hidden" id="btn-cleanup" onclick="triggerSheetCleanup()">Clean Names</button>
    </div>
    <div id="history-table"></div>
</div>

<div id="modal">
  <div class="modal-content">
    <h2 id="modal-title" style="margin-top:0; font-weight:800; text-transform:uppercase; letter-spacing:-0.02em;">New Entry</h2>
    <img id="modal-img-preview" class="modal-img-preview" src="" alt="Product preview">
    <div class="form-grid" id="fields"></div>
    <div style="margin-top:16px;">
      <label class="lbl">Image URL Override (optional)</label>
      <input type="text" id="inp-Image_URL" placeholder="Paste custom image URL..." style="width:100%; padding:12px; border:1px solid var(--border); border-radius:8px; font-family:inherit;">
    </div>
    <div id="trial-extras" class="hidden">
        <h4 style="margin-top:24px; font-size:0.65rem; text-transform:uppercase; color: var(--text-sub);">Ink Effects / Digital Graphic</h4>
        <div class="check-group" style="border:none; padding-top:0;">
            <label style="display:flex; align-items:center; gap:8px; font-size:0.7rem; font-weight:600;"><input type="checkbox" id="chk-Digital_White_1"> 1 Digital White</label>
            <label style="display:flex; align-items:center; gap:8px; font-size:0.7rem; font-weight:600;"><input type="checkbox" id="chk-Digital_White_2"> 2 Digital White</label>
            <label style="display:flex; align-items:center; gap:8px; font-size:0.7rem; font-weight:600;"><input type="checkbox" id="chk-Glu"> Glu</label>
            <label style="display:flex; align-items:center; gap:8px; font-size:0.7rem; font-weight:600;"><input type="checkbox" id="chk-Gloss"> Gloss</label>
        </div>
    </div>
    <div style="margin-top:40px; display:flex; gap:12px; justify-content: flex-end;">
      <button class="btn" style="background:#f3f4f6; color:#000; margin:0;" onclick="closeModal()">Cancel</button>
      <button class="btn btn-green" style="margin:0; padding-left:30px; padding-right:30px;" onclick="submitEntry()">Save to Cloud</button>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzv2NLG2w_nfLrgwiLBhu38q13cv5R_SE_L8SEHTEwOuspL3XumQjDES1WdcsnUTSZ5/exec";
  const COLS = ["Date", "Production_Line", "Product_Name", "Size", "Surface", "Body_Code", "Engobe_Name", "Engobe_Grammage", "Glaze_Name", "Glaze_Grammage", "Kiln_Temp", "Kiln_Min", "Status"];

  // Task 4: Product catalog for dropdown selector
  const PRODUCT_CATALOG = [
    { name: "Lustra Onyx Feather", sizes: ["1200x1200", "600x1200"], surfaces: ["Polished", "Honed"] },
    { name: "Lustra Onyx Crema", sizes: ["1200x1200"], surfaces: ["Polished"] },
    { name: "Lustra Onyx Sage", sizes: ["1200x1200", "600x1200"], surfaces: ["Polished"] },
    { name: "Serena Crater", sizes: ["1200x1200"], surfaces: ["Honed"] },
    { name: "Serena Valley", sizes: ["1200x1200"], surfaces: ["Honed"] },
    { name: "Lithoform Crosscut Twilight", sizes: ["1200x1200"], surfaces: ["Honed"] },
    { name: "Lithoform Crosscut Vista", sizes: ["600x1200"], surfaces: ["Matte"] },
    { name: "Atlantic Ocean", sizes: ["600x1200"], surfaces: ["Polished"] },
    { name: "Majesto Atlantic Ocean", sizes: ["600x1200"], surfaces: ["Polished"] },
    { name: "Taj Mahal", sizes: ["1200x1200"], surfaces: ["Polished"] },
    { name: "Calacatta Borghini", sizes: ["1200x1200", "600x1200"], surfaces: ["Polished", "Honed"] },
    { name: "Calacatta Oro", sizes: ["1200x1200"], surfaces: ["Polished"] },
    { name: "Pietra Imperiale", sizes: ["1200x1200", "600x1200"], surfaces: ["Honed", "Matte"] },
    { name: "Nero Marquina", sizes: ["1200x1200", "600x1200"], surfaces: ["Polished"] },
    { name: "Sahara Noir", sizes: ["1200x1200"], surfaces: ["Polished", "Honed"] },
    { name: "Statuario Block 16", sizes: ["1200x1200"], surfaces: ["Polished"] },
    { name: "Statuario Block 17", sizes: ["1200x1200"], surfaces: ["Polished"] },
    { name: "Super White", sizes: ["1200x1200", "600x1200"], surfaces: ["Polished"] },
    { name: "Cristallo", sizes: ["1200x1200"], surfaces: ["Polished"] },
    { name: "Travertino Classico", sizes: ["1200x1200", "600x1200"], surfaces: ["Honed", "Matte"] },
  ];
  const LINES = ["Line 1", "Line 2", "Line 3"];
  const BODIES = ["LC BODY", "LW BODY", "R6 BODY", "R7 BODY", "D 11 C BODY"];

  // Task 3: Product Name Cleanup
  const NAME_CLEANUP_TAGS = [/\bfull\b/gi, /\bxxsl\b/gi, /\b20mm\b/gi, /\bantislip\b/gi, /\borganic\b/gi];
  function cleanProductName(name) {
    if (!name) return name;
    let cleaned = name;
    NAME_CLEANUP_TAGS.forEach(tag => { cleaned = cleaned.replace(tag, ''); });
    return cleaned.replace(/\s{2,}/g, ' ').trim();
  }
  function cleanAllProductNames(data) {
    if (!Array.isArray(data)) return data;
    return data.map(row => {
      if (row.Product_Name) row.Product_Name = cleanProductName(row.Product_Name);
      return row;
    });
  }
  function triggerSheetCleanup() {
    if (!confirm('This will permanently clean all product names in Google Sheets (removing Full, xxsl, 20mm, antislip, organic). Proceed?')) return;
    fetch(`${API_URL}?method=CLEANUP_NAMES`, { mode: 'no-cors' })
      .then(() => { alert('Cleanup request sent. Reloading...'); setTimeout(loadData, 2000); });
  }

  // Task 5: Image System
  const IMG_BASE_URL = "https://raw.githubusercontent.com/ErfanTari/Anatolia-Command-Center/Product_Pictures/";
  function getProductImage(productName, imageUrlOverride) {
    if (imageUrlOverride && imageUrlOverride.trim()) return imageUrlOverride.trim();
    if (!productName) return getPlaceholderImage('Unknown');
    const filename = cleanProductName(productName).toLowerCase().replace(/\s+/g, '-') + '.webp';
    return IMG_BASE_URL + filename;
  }
  function getPlaceholderImage(name) {
    return `https://placehold.co/600x360/e5e7eb/6b7280?text=${encodeURIComponent(name)}&font=roboto`;
  }
  function onImgError(img) {
    const name = img.alt || 'Product';
    img.onerror = null;
    img.src = getPlaceholderImage(name);
  }

  // State
  let state = { view: 'live', history: [], trials: [], editMode: false, sortCol: null, sortDir: 'asc', editingRow: null };

  function loadData() {
    document.getElementById('status-text').innerText = "SYNCING";
    const script = document.createElement('script');
    script.src = `${API_URL}?callback=handleResponse&t=${Date.now()}`;
    document.body.appendChild(script);
  }

  window.handleResponse = function(data) {
    state.history = cleanAllProductNames(data.history || []);
    state.trials = cleanAllProductNames(data.trials || []);
    document.getElementById('status-text').innerText = "CONNECTED";
    render();
  };

  function setView(v) {
    state.view = v;
    document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('nav div').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${v}`).classList.remove('hidden');
    document.getElementById(`nav-${v}`).classList.add('active');
    render();
  }

  function render() {
    const live = state.history.filter(i => String(i.Status).trim().toLowerCase() === "in production");
    document.getElementById('live-container').innerHTML = live.map(i => renderCard(i, "live")).join('') + renderAddCard("In Production");

    const trials = state.history.filter(i => String(i.Status).trim().toLowerCase() === "trial");
    document.getElementById('trial-container').innerHTML = trials.map(i => renderCard(i, "trial")).join('') + renderAddCard("Trial");

    if (state.view === 'history') renderHistory();
  }

  function renderCard(i, mode) {
    const t = state.trials.find(x => x.Product_Name === i.Product_Name) || {};
    const image = getProductImage(i.Product_Name || '', i.Image_URL);
    return `
      <div class="card">
        <img src="${image}" class="card-image" alt="${i.Product_Name || ''}" onerror="onImgError(this)">
        <div class="card-head">
          <div class="line-badge">${i.Production_Line}</div>
          <div class="date-val">${i.Date}</div>
        </div>
        <div class="row">
          <span class="lbl">Product & Size</span>
          <span class="main-val">${i.Product_Name} <span class="sub-val">${i.Size}</span></span>
        </div>
        <div class="row">
          <span class="lbl">Body Code & Surface</span>
          <span class="main-val">${i.Body_Code} <span class="sub-val">${i.Surface}</span></span>
        </div>
        <div class="row">
          <span class="lbl">Engobe Specification</span>
          <span class="main-val">${i.Engobe_Name} <span class="sub-val">${i.Engobe_Grammage}</span></span>
        </div>
        <div class="row">
          <span class="lbl">Protection Glaze</span>
          <span class="main-val">${i.Glaze_Name} <span class="sub-val">${i.Glaze_Grammage}</span></span>
        </div>
        <div class="row">
          <span class="lbl">Kiln Parameters</span>
          <span class="main-val">${i.Kiln_Temp}°C <span class="sub-val">${i.Kiln_Min} min</span></span>
        </div>

        ${mode === 'trial' ? `
          <div class="check-group">
            <div class="check-item ${String(t.Digital_White_1).toUpperCase() === "TRUE" ? 'active' : ''}">DW1</div>
            <div class="check-item ${String(t.Digital_White_2).toUpperCase() === "TRUE" ? 'active' : ''}">DW2</div>
            <div class="check-item ${String(t.Glu).toUpperCase() === "TRUE" ? 'active' : ''}">GLU</div>
            <div class="check-item ${String(t.Gloss).toUpperCase() === "TRUE" ? 'active' : ''}">GLOSS</div>
          </div>` : ''}

        <div class="card-actions">
          <button class="btn ${mode === 'live' ? 'btn-blue' : 'btn-green'}" onclick="updateStatus('${encodeURIComponent(i.Product_Name)}', '${mode === 'live' ? 'Produced' : 'In Production'}')">
            ${mode === 'live' ? 'Archive Production' : 'Promote to Live'}
          </button>
          ${mode === 'trial' ? `<button class="btn btn-red" onclick="discardTrial('${encodeURIComponent(i.Product_Name)}')">Discard</button>` : ''}
        </div>
      </div>`;
  }

  function renderAddCard(s) {
    return `<div class="card empty-card" onclick="openModal('${s}')">
              <div style="font-size:2rem; margin-bottom:8px;">+</div>
              <div style="font-weight:700; font-size:0.75rem; letter-spacing:0.05em;">NEW ${s.toUpperCase()}</div>
            </div>`;
  }

  // === Task 1: History CRUD ===
  function toggleEditMode() {
    state.editMode = !state.editMode;
    document.getElementById('btn-edit-mode').classList.toggle('active', state.editMode);
    document.getElementById('btn-add-row').classList.toggle('hidden', !state.editMode);
    document.getElementById('btn-cleanup').classList.toggle('hidden', !state.editMode);
    state.editingRow = null;
    renderHistory();
  }

  function sortHistory(col) {
    if (state.sortCol === col) {
      state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
    } else {
      state.sortCol = col;
      state.sortDir = 'asc';
    }
    renderHistory();
  }

  function renderHistory() {
    const search = document.getElementById('search').value.toLowerCase();
    let histItems = state.history.filter(i =>
      String(i.Status).trim().toLowerCase() === "produced" &&
      String(i.Product_Name).toLowerCase().includes(search)
    );
    if (state.sortCol) {
      histItems.sort((a, b) => {
        const va = (a[state.sortCol] || '').toString().toLowerCase();
        const vb = (b[state.sortCol] || '').toString().toLowerCase();
        const cmp = va.localeCompare(vb, undefined, { numeric: true });
        return state.sortDir === 'asc' ? cmp : -cmp;
      });
    }

    let html = '<table><thead><tr>';
    COLS.forEach(c => {
      const sc = state.sortCol === c ? (state.sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : '';
      html += `<th class="sortable ${sc}" onclick="sortHistory('${c}')">${c.replace(/_/g, ' ')}</th>`;
    });
    if (state.editMode) html += '<th>Actions</th>';
    html += '</tr></thead><tbody>';

    histItems.forEach(row => {
      const rowIdx = state.history.indexOf(row);
      html += `<tr data-row-idx="${rowIdx}">`;
      COLS.forEach(c => {
        if (state.editMode && state.editingRow === rowIdx) {
          html += `<td class="editing"><input type="text" value="${(row[c] || '').toString().replace(/"/g, '&quot;')}" data-col="${c}"></td>`;
        } else {
          html += `<td>${row[c] || ''}</td>`;
        }
      });
      if (state.editMode) {
        html += '<td>';
        if (state.editingRow === rowIdx) {
          html += `<div class="row-actions" style="opacity:1;">
            <button class="row-action-btn save" onclick="saveHistoryRow(${rowIdx})" title="Save">&#10003;</button>
            <button class="row-action-btn" onclick="cancelEditRow()" title="Cancel">&#10005;</button>
          </div>`;
        } else {
          html += `<div class="row-actions">
            <button class="row-action-btn" onclick="editHistoryRow(${rowIdx})" title="Edit">&#9998;</button>
            <button class="row-action-btn delete" onclick="deleteHistoryRow(${rowIdx})" title="Delete">&#10005;</button>
          </div>`;
        }
        html += '</td>';
      }
      html += '</tr>';
    });
    document.getElementById('history-table').innerHTML = html + '</tbody></table>';
  }

  function editHistoryRow(idx) { state.editingRow = idx; renderHistory(); }
  function cancelEditRow() { state.editingRow = null; renderHistory(); }

  function saveHistoryRow(idx) {
    const row = state.history[idx];
    const tr = document.querySelector(`tr[data-row-idx="${idx}"]`);
    const inputs = tr.querySelectorAll('input[data-col]');
    const updates = {};
    inputs.forEach(inp => { updates[inp.dataset.col] = inp.value; row[inp.dataset.col] = inp.value; });
    const params = new URLSearchParams({ method: 'UPDATE_ROW', Original_Name: encodeURIComponent(row.Product_Name), ...updates });
    fetch(`${API_URL}?${params.toString()}`, { mode: 'no-cors' }).then(() => { setTimeout(loadData, 1200); });
    state.editingRow = null;
    renderHistory();
  }

  function deleteHistoryRow(idx) {
    const row = state.history[idx];
    if (!confirm(`Delete "${row.Product_Name}" from history? This cannot be undone.`)) return;
    state.history.splice(idx, 1);
    renderHistory();
    fetch(`${API_URL}?method=DELETE_ROW&Product_Name=${encodeURIComponent(row.Product_Name)}`, { mode: 'no-cors' })
      .then(() => { setTimeout(loadData, 1200); });
  }

  function addHistoryRow() { openModal('Produced'); }

  // === Task 2: R&D Discard ===
  function discardTrial(encodedName) {
    const name = decodeURIComponent(encodedName);
    if (!confirm(`Are you sure you want to discard this trial? This action cannot be undone.\n\nProduct: ${name}`)) return;
    state.history = state.history.filter(r => r.Product_Name !== name);
    render();
    fetch(`${API_URL}?method=DELETE_ROW&Product_Name=${encodeURIComponent(name)}`, { mode: 'no-cors' })
      .then(() => { setTimeout(loadData, 1200); });
  }

  // === Task 4: Modal with hybrid dropdown ===
  function openModal(s) {
    state.curStatus = s;
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modal-title').innerText = `Add ${s}`;
    document.getElementById('modal-img-preview').style.display = 'none';
    document.getElementById('inp-Image_URL').value = '';

    let html = '';
    COLS.forEach(c => {
      if (c === "Status") {
        html += `<input type="hidden" id="inp-Status" value="${s}">`;
        return;
      }
      html += '<div>';
      html += `<label class="lbl">${c.replace(/_/g, ' ')}</label>`;

      if (c === 'Product_Name') {
        const opts = PRODUCT_CATALOG.map(p => `<option value="${p.name}">`).join('');
        html += `<input type="text" id="inp-Product_Name" list="product-list" placeholder="Select or type..." oninput="onProductChange(this.value)" autocomplete="off">
          <datalist id="product-list">${opts}</datalist>`;
      } else if (c === 'Production_Line') {
        html += `<select id="inp-Production_Line"><option value="">Select...</option>${LINES.map(l => `<option value="${l}">${l}</option>`).join('')}</select>`;
      } else if (c === 'Body_Code') {
        html += `<select id="inp-Body_Code"><option value="">Select...</option>${BODIES.map(b => `<option value="${b}">${b}</option>`).join('')}</select>`;
      } else if (c === 'Size') {
        html += `<select id="inp-Size"><option value="">Select product first...</option></select>`;
      } else if (c === 'Surface') {
        html += `<select id="inp-Surface"><option value="">Select product first...</option></select>`;
      } else if (c === 'Date') {
        html += `<input type="date" id="inp-Date">`;
      } else {
        html += `<input type="text" id="inp-${c}" placeholder="${c.replace(/_/g, ' ')}">`;
      }
      html += '</div>';
    });

    document.getElementById('fields').innerHTML = html;
    if (s.toLowerCase() === "trial") document.getElementById('trial-extras').classList.remove('hidden');
    else document.getElementById('trial-extras').classList.add('hidden');
  }

  function onProductChange(productName) {
    const product = PRODUCT_CATALOG.find(p => p.name === productName);
    if (product) {
      const sizeEl = document.getElementById('inp-Size');
      if (sizeEl) sizeEl.innerHTML = '<option value="">Select...</option>' + product.sizes.map(s => `<option value="${s}">${s}</option>`).join('');
      const surfEl = document.getElementById('inp-Surface');
      if (surfEl) surfEl.innerHTML = '<option value="">Select...</option>' + product.surfaces.map(s => `<option value="${s}">${s}</option>`).join('');
    }
    const preview = document.getElementById('modal-img-preview');
    if (preview && productName) {
      const urlOverride = document.getElementById('inp-Image_URL');
      preview.src = getProductImage(productName, urlOverride ? urlOverride.value : '');
      preview.onerror = function() { onImgError(this); };
      preview.alt = productName;
      preview.style.display = 'block';
    }
  }
  window.onProductChange = onProductChange;

  function submitEntry() {
    let p = { method: "SAVE" };
    COLS.forEach(c => {
      const el = document.getElementById(`inp-${c}`);
      if (el) p[c] = el.value;
    });
    const imgUrl = document.getElementById('inp-Image_URL');
    if (imgUrl && imgUrl.value.trim()) p['Image_URL'] = imgUrl.value.trim();
    if (state.curStatus.toLowerCase() === "trial") {
      ["Digital_White_1", "Digital_White_2", "Glu", "Gloss"].forEach(id => {
        p[id] = document.getElementById(`chk-${id}`).checked ? "TRUE" : "FALSE";
      });
    }
    fetch(`${API_URL}?${new URLSearchParams(p).toString()}`, { mode: 'no-cors' }).then(() => {
      setTimeout(() => { closeModal(); loadData(); }, 1200);
    });
  }

  function updateStatus(name, s) {
    fetch(`${API_URL}?method=UPDATE_STATUS&Product_Name=${name}&NewStatus=${s}`, { mode: 'no-cors' }).then(() => {
      setTimeout(() => { loadData(); }, 1200);
    });
  }

  function closeModal() { document.getElementById('modal').style.display = 'none'; }
  loadData();
</script>
</body>
</html>
