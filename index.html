<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Anatolia â€” Command Center Master</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #ffffff; --border: #000000; --green: #10b981; --red: #ef4444; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #000; }
    nav { background: #000; color: #fff; display: flex; padding: 0 40px; gap: 30px; position: sticky; top: 0; z-index: 100; }
    nav div { padding: 20px 0; cursor: pointer; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; border-bottom: 3px solid transparent; opacity: 0.6; }
    nav div.active { border-color: #fff; opacity: 1; }
    .view { padding: 40px; }
    .hidden { display: none; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; }
    .status-card { border: 2px solid var(--border); padding: 20px; background: #fff; display: flex; flex-direction: column; min-height: 280px; }
    .status-card.empty-card { border: 2px dashed #ccc; align-items: center; justify-content: center; cursor: pointer; color: #999; font-weight: 800; }
    .card-id { font-weight: 800; font-size: 0.65rem; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; }
    .data-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 8px; }
    .lbl { font-size: 0.55rem; color: #666; font-weight: 700; text-transform: uppercase; }
    .val { font-size: 0.8rem; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .btn { background: #000; color: #fff; border: none; padding: 10px 20px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; cursor: pointer; margin-top: 5px; }
    .btn-green { background: var(--green); }
    #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; display: none; flex-direction: column; padding: 60px; box-sizing: border-box; overflow-y: auto; }
    .sync-indicator { font-size: 0.6rem; font-weight: 800; color: var(--green); margin-bottom: 10px; display: block; }
  </style>
</head>
<body>

<nav>
  <div id="nav-live" class="active" onclick="setView('live')">Production Live</div>
  <div id="nav-trials" onclick="setView('trials')">R&D Trials</div>
  <div id="nav-history" onclick="setView('history')">Master History</div>
</nav>

<div id="view-live" class="view">
  <span id="sync-status" class="sync-indicator">READY</span>
  <div class="grid-container" id="live-container"></div>
</div>

<div id="view-trials" class="view hidden">
  <div class="grid-container" id="trial-container"></div>
</div>

<div id="view-history" class="view hidden">
    <div style="margin-bottom:20px; display:flex; gap:10px;">
        <input type="text" id="search-input" placeholder="Search product..." oninput="renderHistory()" style="flex:1; padding:10px; border:2px solid #000;">
        <button class="btn btn-green" onclick="loadCloudData()">Refresh Cloud</button>
    </div>
    <div id="history-table" style="overflow-x:auto;"></div>
</div>

<div id="modal">
  <div style="max-width:800px; margin: 0 auto; width:100%;">
    <h2 id="modal-title" style="font-weight:800; text-transform:uppercase; font-size:1.2rem; margin-bottom:30px;">Editor</h2>
    <div id="modal-fields" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"></div>
    <div style="margin-top:40px; display:flex; gap:10px;">
      <button class="btn btn-green" onclick="saveEntry()">Create Card</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  const API_URL = "PASTE_YOUR_LATEST_DEPLOY_URL_HERE";
  const CSV_COLUMNS = ["Date", "Production_Line", "Product_Name", "Surface", "Body_Code", "Engobe_Name", "Engobe_Density", "Engobe_Grammage", "Glaze_Name", "Glaze_Density", "Glaze_Grammage", "Kiln_Min", "Kiln_Temp", "Drying_Duration", "Drying_Temp", "Source_File", "Digital_Type"];

  let state = {
    view: 'live',
    live: [{ active: false, line: '1' }, { active: false, line: '2' }, { active: false, line: '3' }],
    trials: [],
    history: []
  };

  function setView(v) {
    state.view = v;
    document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('nav div').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${v}`).classList.remove('hidden');
    document.getElementById(`nav-${v}`).classList.add('active');
    render();
  }

  function loadCloudData() {
    document.getElementById('sync-status').innerText = "FETCHING...";
    const script = document.createElement('script');
    script.src = `${API_URL}?callback=handleResponse&t=${Date.now()}`;
    document.body.appendChild(script);
  }

  window.handleResponse = function(data) {
    state.history = data;
    const lines = ['Line 1', 'Line 2', 'Line 3'];
    lines.forEach((ln, idx) => {
        const match = data.filter(r => String(r.Production_Line).trim() === ln).sort((a,b) => String(b.Date).localeCompare(String(a.Date)))[0];
        state.live[idx] = match ? { ...match, active: true, line: (idx+1).toString() } : { active: false, line: (idx+1).toString() };
    });
    state.trials = data.filter(r => String(r.Production_Line).toLowerCase().includes("trial"));
    document.getElementById('sync-status').innerText = "CONNECTED";
    render();
  };

  function render() {
    renderLive();
    renderTrials();
    renderHistory();
  }

  function renderLive() {
    document.getElementById('live-container').innerHTML = state.live.map((l, i) => {
      if (!l.active) return `<div class="status-card empty-card" onclick="openEditor('live', ${i})">+ LINE ${l.line} EMPTY</div>`;
      return `<div class="status-card">
          <div class="card-id">LINE ${l.line}</div>
          <div class="data-row"><div><span class="lbl">Product</span><span class="val">${l.Product_Name}</span></div></div>
          <div style="margin-top:auto;">
            <button class="btn btn-green" onclick="pushToCloudCard('live', ${i})">Save to Cloud</button>
            <button class="btn" onclick="openEditor('live', ${i})">Update</button>
          </div>
      </div>`;
    }).join('');
  }

  function renderTrials() {
    document.getElementById('trial-container').innerHTML = state.trials.map((t, i) => `
      <div class="status-card" style="border-style:dashed;">
        <div class="card-id">TRIAL CARD</div>
        <div class="data-row"><div><span class="lbl">Product</span><span class="val">${t.Product_Name || '---'}</span></div></div>
        <div style="margin-top:auto;">
            <button class="btn btn-green" onclick="pushToCloudCard('trials', ${i})">Save to Cloud</button>
            <button class="btn" onclick="openEditor('trials', ${i})">Edit</button>
        </div>
      </div>`).join('') + `<div class="status-card empty-card" onclick="openEditor('trials', -1)">+ NEW TRIAL</div>`;
  }

  function renderHistory() {
    const tableDiv = document.getElementById('history-table');
    const search = document.getElementById('search-input')?.value.toLowerCase() || "";
    let filtered = state.history.filter(r => String(r.Product_Name).toLowerCase().includes(search));
    const bodyHtml = filtered.map(row => `<tr>${CSV_COLUMNS.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`).join('');
    tableDiv.innerHTML = `<table style="width:100%; border-collapse:collapse; font-size:0.65rem;"><thead><tr>${CSV_COLUMNS.map(c => `<th style="text-align:left; background:#eee; padding:5px;">${c}</th>`).join('')}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
  }

  function openEditor(type, index) {
    state.editingType = type; state.editingIndex = index;
    const item = (index === -1) ? {} : (type === 'live' ? state.live[index] : state.trials[index]);
    document.getElementById('modal').style.display = 'flex';
    document.getElementById('modal-fields').innerHTML = CSV_COLUMNS.map(col => `
        <div><label class="lbl">${col}</label><input type="text" id="inp-${col}" value="${item[col] || ''}" style="width:100%; padding:8px; border:1px solid #000; box-sizing:border-box;"></div>
    `).join('');
  }

  function saveEntry() {
    let entry = {};
    CSV_COLUMNS.forEach(col => { entry[col] = document.getElementById(`inp-${col}`).value; });
    if (state.editingType === 'trials') {
        entry.Production_Line = "Trial";
        if (state.editingIndex === -1) state.trials.push(entry); else state.trials[state.editingIndex] = entry;
    } else {
        entry.Production_Line = 'Line ' + (state.editingIndex + 1);
        state.live[state.editingIndex] = {...entry, active: true};
    }
    closeModal(); render();
  }

  function pushToCloudCard(type, index) {
    const entry = type === 'live' ? state.live[index] : state.trials[index];
    if (!entry.Date) entry.Date = new Date().toLocaleDateString('tr-TR');
    const params = new URLSearchParams(entry).toString();
    const img = new Image();
    img.src = `${API_URL}?${params}`;
    img.onload = () => { alert("Saved to Cloud Successfully!"); loadCloudData(); };
  }

  function closeModal() { document.getElementById('modal').style.display = 'none'; }
  loadCloudData();
</script>
</body>
</html>
