<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Anatolia — Command Center Master</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg: #ffffff; --border: #000000; --green: #10b981; --red: #ef4444; }
    body { font-family: 'Inter', sans-serif; margin: 0; background: var(--bg); color: #000; }
    nav { background: #000; color: #fff; display: flex; padding: 0 40px; gap: 30px; position: sticky; top: 0; z-index: 100; }
    nav div { padding: 20px 0; cursor: pointer; font-size: 0.7rem; font-weight: 800; text-transform: uppercase; border-bottom: 3px solid transparent; opacity: 0.6; }
    nav div.active { border-color: #fff; opacity: 1; }
    .view { padding: 40px; }
    .hidden { display: none; }
    .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
    .status-card { border: 2px solid var(--border); padding: 20px; background: #fff; }
    .status-card.empty-card { border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; min-height: 180px; cursor: pointer; color: #999; }
    .card-id { font-weight: 800; font-size: 0.6rem; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; }
    .data-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .lbl { font-size: 0.55rem; color: #666; font-weight: 700; text-transform: uppercase; }
    .val { font-size: 0.85rem; font-weight: 600; }
    .btn { background: #000; color: #fff; border: none; padding: 10px 20px; font-size: 0.6rem; font-weight: 800; text-transform: uppercase; cursor: pointer; }
    .btn-green { background: var(--green); }
    #modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 1000; display: none; flex-direction: column; padding: 60px; box-sizing: border-box; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.7rem; margin-top: 20px; }
    th { background: #eee; text-align: left; padding: 10px; border: 1px solid #ddd; cursor: pointer; }
    td { padding: 10px; border: 1px solid #ddd; }
    .sync-indicator { font-size: 0.6rem; font-weight: 800; color: var(--green); margin-bottom: 10px; display: block; }
  </style>
</head>
<body>

<nav>
  <div id="nav-live" class="active" onclick="setView('live')">Production Live</div>
  <div id="nav-trials" onclick="setView('trials')">R&D Trials</div>
  <div id="nav-history" onclick="setView('history')">Master History</div>
</nav>

<div id="view-live" class="view">
  <span id="sync-status" class="sync-indicator">READY</span>
  <div class="grid-container" id="live-container"></div>
</div>

<div id="view-trials" class="view hidden">
  <div class="grid-container" id="trial-container"></div>
</div>

<div id="view-history" class="view hidden">
    <div style="display:flex; gap:10px; margin-bottom:20px;">
        <button class="btn" onclick="exportMaster()">Export CSV</button>
        <button class="btn btn-green" onclick="loadCloudData()">Refresh from Cloud</button>
    </div>
    <div id="history-table" style="overflow-x:auto;"></div>
</div>

<div id="modal">
  <div style="max-width:600px; margin: 0 auto; width:100%;">
    <h2 id="modal-title" style="font-weight:800; text-transform:uppercase; font-size:1.2rem; margin-bottom:30px;">Editor</h2>
    <div id="modal-fields" style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"></div>
    <div style="margin-top:40px; display:flex; gap:10px;">
      <button id="save-btn" class="btn btn-green" onclick="saveEntry()">Save to Cloud</button>
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
  // PASTE YOUR NEW DEPLOYMENT URL HERE
  const API_URL = "https://script.google.com/macros/s/AKfycbyUylSn0XWy6iTVSqrjwDmmSkXHl0EOx9wf1ovtp3TLvlj5KeFgziGr92H3CQ1PrEi-/exec";
  
  const CSV_COLUMNS = ["Date", "Production_Line", "Product_Name", "Surface", "Body_Code", "Body_Full", "Engobe_Name", "Engobe_Density", "Engobe_Grammage", "Glaze_Name", "Glaze_Density", "Glaze_Grammage", "Kiln_Min", "Kiln_Temp", "Drying_Duration", "Drying_Temp", "Source_File"];
  const fieldMap = {"Date": "Date", "Production_Line": "Production Line", "Product_Name": "Product Name", "Surface": "Surface", "Body_Code": "Body Code", "Body_Full": "Body Full", "Engobe_Name": "Engobe Name", "Engobe_Density": "Engobe Density", "Engobe_Grammage": "Engobe Grammage", "Glaze_Name": "Glaze Name", "Glaze_Density": "Glaze Density", "Glaze_Grammage": "Glaze Grammage", "Kiln_Min": "Kiln Min", "Kiln_Temp": "Kiln Temp", "Drying_Duration": "Drying Duration", "Drying_Temp": "Drying Temp", "Source_File": "Source File"};

  let state = {
    view: 'live',
    live: [{ active: false, line: '1' }, { active: false, line: '2' }, { active: false, line: '3' }],
    trials: [],
    history: [],
    sortKey: 'Date',
    sortAsc: false
  };

  // NEW JSONP FETCH LOGIC
  function loadCloudData() {
    document.getElementById('sync-status').innerText = "FETCHING CLOUD DATA...";
    
    // Create a temporary "bridge" function
    const script = document.createElement('script');
    script.src = `${API_URL}?callback=handleResponse`;
    document.body.appendChild(script);
  }

  // This runs automatically when Google replies
  window.handleResponse = function(data) {
    state.history = data;
    const lines = ['Line 1', 'Line 2', 'Line 3'];
    lines.forEach((ln, idx) => {
        const match = data.filter(r => r.Production_Line === ln)
                          .sort((a,b) => b.Date.localeCompare(a.Date))[0];
        if (match) state.live[idx] = { ...match, active: true, line: (idx+1).toString() };
    });
    document.getElementById('sync-status').innerText = "CLOUD SYNCED";
    render();
  };

  function setView(v) {
    state.view = v;
    document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('nav div').forEach(el => el.classList.remove('active'));
    document.getElementById(`view-${v}`).classList.remove('hidden');
    document.getElementById(`nav-${v}`).classList.add('active');
    render();
  }

  function render() {
    renderLive();
    renderHistory();
  }

  function renderLive() {
    document.getElementById('live-container').innerHTML = state.live.map((l, i) => {
      if (!l.active) return `<div class="status-card empty-card" onclick="openEditor('live', ${i})"><div style="text-align:center;">+ LINE ${l.line} EMPTY</div></div>`;
      return `<div class="status-card">
          <div class="card-id">LINE ${l.line} <span style="color:var(--green)">● ACTIVE</span></div>
          <div class="data-row"><div><span class="lbl">Product</span><span class="val">${l.Product_Name}</span></div></div>
          <div class="data-row"><div><span class="lbl">Surface</span><span class="val">${l.Surface}</span></div></div>
          <div style="margin-top:10px;"><button class="btn btn-green" onclick="archiveLive(${i})">Archive Run</button></div>
      </div>`;
    }).join('');
  }

  function renderHistory() {
    const tableDiv = document.getElementById('history-table');
    if (!tableDiv) return;
    const bodyHtml = state.history.map(row => `<tr>${CSV_COLUMNS.map(col => `<td>${row[col] || ''}</td>`).join('')}</tr>`).join('');
    tableDiv.innerHTML = `<table><thead><tr>${CSV_COLUMNS.map(c => `<th>${fieldMap[c]}</th>`).join('')}</tr></thead><tbody>${bodyHtml}</tbody></table>`;
  }

  function pushToCloud(entry) {
    const params = new URLSearchParams(entry).toString();
    const img = new Image(); // Using an image pixel to send data - ignores all CORS blocks
    img.src = `${API_URL}?${params}&method=POST`;
    document.getElementById('sync-status').innerText = "DATA SENT";
  }

  function archiveLive(index) {
    const entry = { ...state.live[index] };
    delete entry.active; delete entry.line;
    pushToCloud(entry);
    state.live[index] = { active: false, line: (index + 1).toString() };
    render();
  }

  render();
  loadCloudData();
</script>
</body>
</html>
